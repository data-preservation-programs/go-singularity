---
description: 개발자들이 싱귤래리티에서 데이터 준비 프로세스를 이해하기 원하는 경우, 이 문서는 기술적 개요를 제공합니다.
---

# 싱귤래리티에서의 데이터 준비 아키텍처

![싱귤래리티 데이터 준비 모델](data-prep-model.jpg)

# 데이터셋 및 소스

데이터셋은 복제에 대한 공통 정책 및 하나 이상의 연관된 Filecoin 지갑과 함께 있는 데이터 집합입니다.

각 데이터셋은 하나 이상의 데이터 소스를 가질 수 있습니다. 데이터 소스는 로컬 파일 저장소를 포함한 [RClone](https://github.com/rclone/rclone)에서 지원하는 저장소에 저장된 데이터 폴더를 가리킵니다.

데이터 준비는 싱귤래리티 사용자가 다음 단계를 수행할 때 시작됩니다:
1. 데이터셋을 생성합니다.
2. 데이터셋에 소스를 추가합니다.
3. 데이터 준비 작업자를 시작합니다.

# 스캐닝

데이터 준비의 첫 번째 단계는 데이터 소스를 스캔하여 파일과 폴더로 구성된 디렉토리 트리 구조 및 파일을 CAR 파일로 어떻게 청크(chunk)로 나눌지에 대한 계획을 만드는 것입니다.

데이터 소스의 디렉토리 트리 구조를 나타내는 모델은 디렉토리(Directory)와 항목(Item)입니다. 스캔 프로세스에서 RClone은 데이터 소스의 디렉토리 구조를 매핑한 다음, 이 디렉토리 구조에서 디렉토리 및 항목 모델을 생성합니다. 이때 데이터 소스의 루트 디렉토리를 시작으로 디렉토리 및 항목 모델이 구성됩니다.

각 항목에 대해 스캔 프로세스는 또한 항목의 연속된 파일 부분을 나타내는 항목 파트(ItemPart)를 생성합니다. 이 크기는 구성 가능한 1GB까지 입니다. 또한, 항목 파트의 집합들은 CAR 파일에 저장할 수 있을 만큼 충분한 크기의 항목 파트들을 하나로 묶은 청크(Chunk)에 추가됩니다. 이 청크는 단순히 CAR 파일에 담기 위해 함께 묶은 항목 파트들의 목록입니다. 이렇게 스캔 프로세스가 완료되면, 우리는 항목들의 목록을 가진 디렉토리 트리, 각각의 파일을 1GB까지 나눈 항목들의 집합인 항목 파트들, 그리고 Filecoin의 32GB 조각에 저장할 수 있는 CAR 파일에 들어갈 항목 파트들의 집합인 청크들을 얻게 됩니다.

데이터 소스는 변경될 수 있으므로, 파일과 폴더가 추가되거나 변경, 삭제될 때마다 재스캔될 수도 있습니다.

# 패킹

소스가 스캔되면, CAR 파일로 패킹할 준비가 됩니다. 패킹은 청크들을 실제로 기록된 개별 블록을 가진 CAR 파일로 변환하는 과정입니다.

CAR 파일을 패킹하기 위해, 청크의 각 항목 파트는 지정된 블록 크기로 읽혀서 IPLD Raw 블록으로 청킹(chunking)되고, 각각의 Raw 블록은 CAR에 기록됩니다. 모든 Raw 블록이 기록된 후, 항목 파트에 둘 이상의 Raw 블록이 포함되어 있다면, UnixFS 중간 노드 블록의 트리를 구성하여 Raw 블록을 결합하고 항목 파트에 대한 루트 CID를 생성합니다. 이 프로세스가 완료되면, 해당 청크의 모든 항목 파트에 대한 Raw 블록과 UnixFS 중간 노드 블록이 포함된 CAR 파일이 생성됩니다.

패킹 프로세스가 끝나면, 싱귤래리티는 또한 데이터베이스에 Car 모델을 작성하여 Car 파일을 나타냅니다. 또한, CAR에 있는 각 블록에 대해 CarBlock을 작성합니다.

Car 작성이 완료되면, 우리는 디렉토리와 항목에 돌아갑니다. 모든 항목의 항목 파트가 기록된 경우, 해당 항목의 모든 항목 파트를 연결하여 해당 항목의 단일 UnixFS 파일로 연결하는 추가적인 UnixFS 중간 노드 트리를 구성합니다. 또한, 각 디렉토리에 대해 UnixFS 디렉토리 노드를 조립하여 업데이트합니다. 이 데이터는 일시적으로 데이터베이스에 저장되며, 디렉토리 객체와 연결됩니다.

패킹 프로세스가 완료되면, 우리는 데이터 소스의 모든 항목 파트를 저장할 CAR 파일을 가지게 됩니다. 그러나 이 시점에서는 데이터 소스의 디렉토리(Directories)와 파일(Items)을 나타내는 UnixFS DAG를 조립했지만, 이를 자체 CAR로 직렬화하여 Filecoin에 저장하지 않았습니다.

# Daggen

파일 및 디렉토리 구조가 시간이 지남에 따라 변경될 수 있으므로, 이 구조의 스냅샷을 Filecoin에 저장하기 위해 Pack 중에 조립된 UnixFS DAG 트리를 직렬화하는 것은 수동 준비 단계입니다. 사용자가 별도로 이 단계를 시작하면, Pack 중에 작성되지 않은 UnixFS DAG 트리가 Filecoin에 저장할 CAR로 직렬화됩니다. 이 작업이 완료되면, 데이터 준비 프로세스에서 작성된 모든 CAR을 Filecoin에 저장한다면, 데이터 소스의 전체 스냅샷을 검색하는 데 필요한 모든 것을 Filecoin에 저장하게 됩니다.