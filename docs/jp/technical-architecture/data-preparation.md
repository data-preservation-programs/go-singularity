---
description: Singularityのデータ準備のプロセスを理解したい開発者向けに、このドキュメントは技術的な概要を提供します
---

# Singularityのデータ準備のアーキテクチャ

![Singularityデータ準備モデル](data-prep-model.jpg)

# データセットとデータソース

データセットは、複製のための共通ポリシーを持つデータのセットであり、1つ以上の関連するFilecoinウォレットを持つことができます。

各データセットは、データのソースを1つ以上持つことができます。ソースは、ローカルファイルストレージを含む[RClone](https://github.com/rclone/rclone)でサポートされたストレージに保存されるデータのフォルダへのポインタです。

データの準備は、Singularityユーザーが次の手順を実行することで開始されます：
1. データセットの作成
2. データセットにソースを追加
3. データ準備ワーカーの開始

# スキャン

データの準備の最初の段階は、データソースのスキャンです。スキャンでは、データソースが含むファイルとフォルダのディレクトリツリー構造と、それらのファイルをCARファイルに分割するための計画が構築されます。

データソースのディレクトリツリー構造を表すために使用されるモデルは、ディレクトリとアイテムです（ディレクトリはフォルダであり、アイテムはファイルです）。スキャンプロセスでは、RCloneを使用してデータソースのディレクトリ構造をマッピングし、その後、このディレクトリ構造からディレクトリとアイテムモデルが作成されます。データソースのルートディレクトリから始めて、このディレクトリ構造からディレクトリとアイテムモデルを組み立てます。データソースが登録された時点で作成されました。

データソースの各アイテムについて、スキャンプロセスはまた、1GBまでのファイルの連続した部分を表すItemPartsも作成します（このサイズは設定できます）。さらに、ItemPartsのセットはChunkに追加されます。Chunkは、単一のCARファイルに格納するのに十分なItemPartsのリストです。

スキャンプロセスの終了時には、アイテムごとに1GBまでのファイルの部分を表すItemPartsに分割された各アイテムを含むディレクトリのツリーが得られます。さらに、ItemPartsのセットであるChunkもあります。Chunkは、単一のCARファイルにまとめられるItemPartsのセットにリンクします。

注意点として、データソースは変更される可能性があるため、ファイルやフォルダが追加、変更、削除される場合は再スキャンする必要があります。

# パッキング

ソースがスキャンされたら、CARファイルにパックする準備ができています。パッキングは、Chunおよび実際の書き込まれたCARファイルにChunksを変換するプロセスです。

CARファイルをパックするために、Chunk内の各ItemPartは読み取られ、指定されたブロックサイズのIPLD Rawブロックに分割され、それぞれがCARに書き込まれます。すべてのRaw Blocksが書き込まれた後、ItemPartに複数のRaw Blocksが含まれている場合、UnixFSの中間ノードブロックのツリーが組み立てられ、これらのRaw Blocksをリンクし、ItemPartのルートCIDを生成します。このプロセスが完了すると、Chunk内のすべてのItemPartのRaw BlocksとUnixFSの中間ノードブロックが含まれるCARファイルができあがります。

パッキングプロセスの最後に、SingularityはCarモデルをデータベースに書き込み、Carファイルを表現し、CAR内のすべてのブロックに対してCarBlockも書き込みます。

各Carの書き込みが完了すると、ディレクトリとアイテムに戻ります。すべてのItemPartsが書き込まれたアイテムごとに、ItemPartsを接続し、アイテムのための単一のUnixFSファイルとしてまとめるための追加のUnixFSの中間ノードツリーを作成します。また、それぞれのディレクトリに対してUnixFSディレクトリノードを組み立てて更新します。このデータは一時的にデータベースに保存され、ディレクトリオブジェクトにリンクされます。

パッキングプロセスが完了すると、データソースのすべてのアイテムパートを格納するCARファイルが完成します。ただし、この時点では、データソースからファイル（アイテム）とディレクトリ（ディレクトリ）を表すUnixFSのDAGを作成しても、それ自体のCARとしてFilecoinに格納していません。

# Daggen

ファイルやディレクトリの構造が時間とともに変更されるため、この構造のスナップショットをFilecoinに格納するために、Daggenと呼ばれる手動の準備手順があります。ユーザーがこのステップを別々に開始すると、パック中に組み立てられたUnixFS DAGツリーがCARにシリアル化され、Filecoinに格納されます。これが完了すると、データ準備プロセスで書き込まれたすべてのCARをFilecoinに保存する場合、データソースの完全なスナップショットをFilecoinから取得するために必要なすべてが保存されることになります。